<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>継続学習モデル選択テスト</title>
</head>
<body>
    <h1>継続学習モデル選択テスト</h1>
    
    <div>
        <label for="baseModel">ベースモデル:</label>
        <select id="baseModel" required>
            <option value="">モデルを選択してください</option>
        </select>
        <small id="modelInfo" style="color: #666; font-size: 12px;"></small>
    </div>
    
    <div id="status" style="margin-top: 20px; padding: 10px; background: #f0f0f0;">
        <h3>ステータス:</h3>
        <div id="statusContent">待機中...</div>
    </div>
    
    <div id="errorLog" style="margin-top: 20px; padding: 10px; background: #ffe0e0;">
        <h3>エラーログ:</h3>
        <div id="errorContent">なし</div>
    </div>

    <script>
    // デバッグ用ログ関数
    function logStatus(message) {
        console.log(message);
        const statusDiv = document.getElementById('statusContent');
        statusDiv.innerHTML += `<p>${new Date().toLocaleTimeString()}: ${message}</p>`;
    }
    
    function logError(message, error = null) {
        console.error(message, error);
        const errorDiv = document.getElementById('errorContent');
        if (errorDiv.textContent === 'なし') {
            errorDiv.innerHTML = '';
        }
        errorDiv.innerHTML += `<p style="color: red;">${new Date().toLocaleTimeString()}: ${message}</p>`;
        if (error) {
            errorDiv.innerHTML += `<pre>${JSON.stringify(error, null, 2)}</pre>`;
        }
    }
    
    // モデル一覧を更新
    async function refreshModels() {
        try {
            logStatus('APIからモデル一覧を取得中...');
            
            const response = await fetch('http://localhost:8050/api/continual-learning/models');
            
            logStatus(`HTTPステータス: ${response.status} ${response.statusText}`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const models = await response.json();
            logStatus(`取得したモデル数: ${models.length}`);
            console.log('取得したモデル一覧:', models);
            
            const select = document.getElementById('baseModel');
            
            // 現在の選択肢をクリア
            select.innerHTML = '<option value="">モデルを選択してください</option>';
            logStatus('ドロップダウンをクリア');
            
            if (models && models.length > 0) {
                // ベースモデルのグループ
                const baseModels = models.filter(m => m.type === 'base');
                logStatus(`ベースモデル数: ${baseModels.length}`);
                
                if (baseModels.length > 0) {
                    const baseGroup = document.createElement('optgroup');
                    baseGroup.label = 'ベースモデル';
                    
                    baseModels.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.path;
                        option.textContent = model.name;
                        if (model.description) {
                            option.textContent += ` - ${model.description}`;
                        }
                        baseGroup.appendChild(option);
                        logStatus(`ベースモデル追加: ${model.name}`);
                    });
                    
                    select.appendChild(baseGroup);
                    logStatus('ベースモデルグループを追加');
                }
                
                // ファインチューニング済みモデルのグループ
                const fineTunedModels = models.filter(m => m.type === 'finetuned');
                logStatus(`ファインチューニング済みモデル数: ${fineTunedModels.length}`);
                
                if (fineTunedModels.length > 0) {
                    const ftGroup = document.createElement('optgroup');
                    ftGroup.label = 'ファインチューニング済みモデル';
                    
                    fineTunedModels.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.path;
                        option.textContent = model.name;
                        ftGroup.appendChild(option);
                        logStatus(`FTモデル追加: ${model.name}`);
                    });
                    
                    select.appendChild(ftGroup);
                    logStatus('ファインチューニング済みモデルグループを追加');
                }
                
                // モデル情報を表示
                const modelInfo = document.getElementById('modelInfo');
                if (modelInfo) {
                    modelInfo.textContent = `${models.length}個のモデルが利用可能です (ベース: ${baseModels.length}個, FT済み: ${fineTunedModels.length}個)`;
                    logStatus('モデル情報を更新');
                }
                
                // ドロップダウンの選択肢を確認
                logStatus(`ドロップダウンの選択肢数: ${select.options.length}`);
                logStatus(`optgroupの数: ${select.getElementsByTagName('optgroup').length}`);
            } else {
                logStatus('取得したモデルが0個またはnullです');
            }
            
        } catch (error) {
            logError('モデル一覧取得エラー:', error);
        }
    }
    
    // ページ読み込み時に実行
    window.addEventListener('load', function() {
        logStatus('ページ読み込み完了');
        refreshModels();
    });
    
    // 選択変更時のイベント
    document.getElementById('baseModel').addEventListener('change', function() {
        logStatus(`選択されたモデル: ${this.value}`);
    });
    </script>
</body>
</html>