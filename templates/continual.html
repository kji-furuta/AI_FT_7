{% extends "base.html" %}

{% block title %}継続学習管理システム{% endblock %}

{% block extra_styles %}
<style>
    .continual-container {
        max-width: 1400px;
        margin: 0 auto;
    }

    .tabs {
        display: flex;
        background: #f5f5f5;
        border-radius: 8px;
        margin-bottom: 20px;
        padding: 5px;
    }

    .tab {
        flex: 1;
        padding: 12px 20px;
        cursor: pointer;
        background: transparent;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 500;
        transition: all 0.3s;
        text-align: center;
        color: #666;
    }

    .tab:hover {
        background: rgba(52, 152, 219, 0.1);
    }

    .tab.active {
        background: white;
        color: #2c3e50;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .tab-content {
        display: none;
        animation: fadeIn 0.3s;
    }

    .tab-content.active {
        display: block;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .card {
        background: white;
        border-radius: 8px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .card h2 {
        color: #2c3e50;
        margin-bottom: 20px;
        font-size: 1.5rem;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #2c3e50;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 10px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #3498db;
    }

    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
        background: #95a5a6;
        color: white;
        margin-left: 10px;
    }

    .btn-secondary:hover {
        background: #7f8c8d;
    }

    .task-item {
        background: #f8f9fa;
        border-left: 4px solid #3498db;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 4px;
    }

    .task-item h4 {
        color: #2c3e50;
        margin-bottom: 10px;
    }

    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        margin-left: 10px;
    }

    .status-running {
        background: #f39c12;
        color: white;
    }

    .status-completed {
        background: #27ae60;
        color: white;
    }

    .status-failed {
        background: #e74c3c;
        color: white;
    }

    .progress-bar {
        width: 100%;
        height: 20px;
        background: #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #3498db, #2ecc71);
        transition: width 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
    }

    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    .alert {
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
    }

    .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .alert-info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }
</style>
{% endblock %}

{% block main_title %}
<h1>
    <img src="/static/logo_teikoku.png" alt="Logo" class="title-logo">
    🔄 継続学習管理システム
</h1>
<p>EWCベースの継続学習によるモデルの段階的な改善</p>
{% endblock %}

{% block content %}
<div class="continual-container">
    <div class="card">
        <!-- タブメニュー -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('training')">
                📝 新規学習
            </button>
            <button class="tab" onclick="switchTab('tasks')">
                📋 タスク一覧
            </button>
            <button class="tab" onclick="switchTab('history')">
                📊 学習履歴
            </button>
        </div>

        <!-- 新規学習タブ -->
        <div id="training-tab" class="tab-content active">
            <h2>新しい継続学習タスクを開始</h2>

            
            <form id="continualLearningForm">
                <div class="grid">
                    <div class="form-group">
                        <label for="baseModel">ベースモデル:</label>
                        <select id="baseModel" required>
                            <option value="">モデルを選択してください</option>
                        </select>
                        <small id="modelInfo" style="color: #666; font-size: 12px;"></small>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskName">タスク名:</label>
                        <input type="text" id="taskName" required placeholder="例: specialized_domain_task">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="dataset">学習データセット (JSONL形式):</label>
                    <input type="file" id="dataset" accept=".jsonl" required>
                </div>
                
                <div class="grid">
                    <div class="form-group">
                        <label for="ewcLambda">EWC重要度 (λ):</label>
                        <input type="number" id="ewcLambda" value="5000" min="0" step="100">
                    </div>
                    
                    <div class="form-group">
                        <label for="epochs">エポック数:</label>
                        <input type="number" id="epochs" value="3" min="1" max="10">
                    </div>
                    
                    <div class="form-group">
                        <label for="learningRate">学習率:</label>
                        <input type="number" id="learningRate" value="0.00002" min="0" step="0.000001">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="usePreviousTasks" checked>
                        以前のタスクのFisher行列を使用（破滅的忘却の防止）
                    </label>
                </div>
                
                <button type="submit" class="btn btn-primary">🚀 継続学習を開始</button>
                <button type="button" class="btn btn-secondary" onclick="window.refreshModels(); return false;">🔄 モデル更新</button>
            </form>
            
            <div id="currentTaskStatus" style="margin-top: 20px;">
                <!-- 現在のタスク状態がここに表示されます -->
            </div>
        </div>

        <!-- タスク一覧タブ -->
        <div id="tasks-tab" class="tab-content">
            <h2>実行中のタスク</h2>
            <div id="taskList">
                <p>読み込み中...</p>
            </div>
        </div>

        <!-- 学習履歴タブ -->
        <div id="history-tab" class="tab-content">
            <h2>学習履歴</h2>
            <div id="taskHistory">
                <p>履歴を読み込み中...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
// グローバル変数
let currentTaskId = null;

// モデル一覧を更新する関数（グローバルに定義）
window.refreshModels = async function() {
    console.log('refreshModels関数が呼び出されました');
    
    try {
        // セレクトボックスが存在するか確認
        const select = document.getElementById('baseModel');
        if (!select) {
            console.error('baseModel要素が見つかりません');
            showAlert('エラー: モデル選択ボックスが見つかりません', 'error');
            return;
        }
        
        console.log('APIを呼び出し中: /api/continual-learning/models');
        const response = await fetch('/api/continual-learning/models');
        
        console.log(`APIレスポンス: ${response.status} ${response.statusText}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const models = await response.json();
        console.log('取得したモデル一覧:', models);
        console.log(`モデル数: ${models ? models.length : 0}`);

        
        // 現在の選択肢をクリア
        select.innerHTML = '<option value="">モデルを選択してください</option>';
        console.log('選択肢をクリアしました');
        
        if (models && models.length > 0) {
            // ベースモデルのグループ
            const baseModels = models.filter(m => m.type === 'base');
            console.log(`ベースモデル数: ${baseModels.length}`);
            
            if (baseModels.length > 0) {
                const baseGroup = document.createElement('optgroup');
                baseGroup.label = 'ベースモデル';
                baseModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.path;
                    option.textContent = model.name;
                    if (model.description) {
                        option.textContent += ` - ${model.description}`;
                    }
                    baseGroup.appendChild(option);
                    console.log(`ベースモデル追加: ${model.name}`);
                });
                select.appendChild(baseGroup);
                console.log('ベースモデルグループを追加しました');
            }
            
            // ファインチューニング済みモデルのグループ
            const fineTunedModels = models.filter(m => m.type === 'finetuned');
            console.log(`ファインチューニング済みモデル数: ${fineTunedModels.length}`);
            
            if (fineTunedModels.length > 0) {
                const ftGroup = document.createElement('optgroup');
                ftGroup.label = 'ファインチューニング済みモデル';
                fineTunedModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.path;
                    option.textContent = model.name;
                    ftGroup.appendChild(option);
                    console.log(`FTモデル追加: ${model.name}`);
                });
                select.appendChild(ftGroup);
                console.log('ファインチューニング済みモデルグループを追加しました');
            }
            
            // モデル情報を表示
            const modelInfo = document.getElementById('modelInfo');
            if (modelInfo) {
                modelInfo.textContent = `${models.length}個のモデルが利用可能です (ベース: ${baseModels.length}個, FT済み: ${fineTunedModels.length}個)`;
                console.log('モデル情報を更新しました');
            }
            
            // 最終的な選択肢数を確認
            console.log(`最終的な選択肢数: ${select.options.length}`);
            console.log(`optgroup数: ${select.getElementsByTagName('optgroup').length}`);
        } else {
            console.warn('モデルが0個またはnullです');
            showAlert('利用可能なモデルがありません', 'info');
        }
    } catch (error) {
        console.error('モデル一覧取得エラー:', error);
        console.error('エラー詳細:', error.stack);
        showAlert(`モデル一覧の取得に失敗しました: ${error.message}`, 'error');
    }
};

// ページ読み込み完了後に初期化
window.addEventListener('DOMContentLoaded', function() {
    console.log('継続学習ページ: DOM読み込み完了');
    
    // 少し遅延を入れて、すべての要素が確実に読み込まれるようにする
    setTimeout(function() {
        console.log('継続学習ページ: 初期化開始');
        
        // baseModel要素の存在確認
        const baseModelElement = document.getElementById('baseModel');
        if (!baseModelElement) {
            console.error('エラー: baseModel要素が見つかりません');
            console.log('現在のHTML構造:', document.getElementById('training-tab')?.innerHTML.substring(0, 500));
        } else {
            console.log('baseModel要素を確認:', baseModelElement);
            
            // モデル一覧を更新
            window.refreshModels();

            
            // ベースモデル選択時のイベント
            baseModelElement.addEventListener('change', updateModelInfo);
        }
        
        // タスク一覧を読み込む
        loadTasks();
        
        // フォームのサブミット処理
        const form = document.getElementById('continualLearningForm');
        if (form) {
            form.addEventListener('submit', startContinualLearning);
            console.log('フォームイベントリスナーを設定');
        } else {
            console.error('エラー: continualLearningFormが見つかりません');
        }
        
        // 定期的なタスク更新
        setInterval(loadTasks, 5000);
    }, 100);
});

// タブ切り替え
function switchTab(tabName) {
    // タブボタンの状態を更新
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => tab.classList.remove('active'));
    event.target.classList.add('active');
    
    // タブコンテンツの表示を切り替え
    const contents = document.querySelectorAll('.tab-content');
    contents.forEach(content => content.classList.remove('active'));
    document.getElementById(tabName + '-tab').classList.add('active');
    
    // 履歴タブの場合は履歴を読み込む
    if (tabName === 'history') {
        loadHistory();
    }
}

// モデル選択時の情報表示
function updateModelInfo() {
    const baseModel = document.getElementById('baseModel');
    const modelInfo = document.getElementById('modelInfo');
    
    if (baseModel.value) {
        fetch('/api/continual-learning/models')
            .then(response => response.json())
            .then(models => {
                const selectedModel = models.find(m => m.path === baseModel.value);
                if (selectedModel) {
                    modelInfo.textContent = `タイプ: ${selectedModel.type}, 説明: ${selectedModel.description || 'なし'}`;
                }
            })
            .catch(error => {
                modelInfo.textContent = `エラー: ${error.message}`;
            });
    } else {
        modelInfo.textContent = '';
    }
}

// タスク一覧を読み込む
async function loadTasks() {
    try {
        const response = await fetch('/api/continual-learning/tasks');
        if (response.ok) {
            const tasks = await response.json();
            updateTaskList(tasks);
        }
    } catch (error) {
        console.error('タスク一覧取得エラー:', error);
    }
}

// タスク一覧を更新
function updateTaskList(tasks) {
    const taskList = document.getElementById('taskList');
    if (!taskList) return;
    
    if (tasks && tasks.length > 0) {
        taskList.innerHTML = tasks.map(function(task) {
            return '<div class="task-item">' +
                '<h4>' + task.task_name + '</h4>' +
                '<p>状態: ' + task.status + '</p>' +
                '<p>進捗: ' + (task.progress || 0) + '%</p>' +
                '<p>開始時刻: ' + task.started_at + '</p>' +
            '</div>';
        }).join('');
    } else {
        taskList.innerHTML = '<p>実行中のタスクはありません</p>';
    }
}

// 履歴を読み込む
async function loadHistory() {
    try {
        const response = await fetch('/api/continual-learning/history');
        if (response.ok) {
            const history = await response.json();
            updateHistoryList(history);
        }
    } catch (error) {
        console.error('履歴取得エラー:', error);
    }
}

// 履歴一覧を更新
function updateHistoryList(history) {
    const taskHistory = document.getElementById('taskHistory');
    if (!taskHistory) return;
    
    if (history && history.length > 0) {
        taskHistory.innerHTML = history.map(function(task) {
            return '<div class="task-item">' +
                '<h4>' + task.task_name + '</h4>' +
                '<p>状態: ' + task.status + '</p>' +
                '<p>完了時刻: ' + (task.completed_at || '未完了') + '</p>' +
            '</div>';
        }).join('');
    } else {
        taskHistory.innerHTML = '<p>履歴はありません</p>';
    }
}

// 継続学習を開始
async function startContinualLearning(event) {
    event.preventDefault();
    
    // 入力検証
    const baseModel = document.getElementById('baseModel').value;
    const taskName = document.getElementById('taskName').value;
    const datasetFile = document.getElementById('dataset').files[0];
    
    if (!baseModel) {
        showAlert('エラー: ベースモデルを選択してください', 'error');
        return;
    }
    
    if (!taskName) {
        showAlert('エラー: タスク名を入力してください', 'error');
        return;
    }
    
    if (!datasetFile) {
        showAlert('エラー: データセットファイルを選択してください', 'error');
        return;
    }
    
    const formData = new FormData();
    const config = {
        base_model: baseModel,
        task_name: taskName,
        use_previous_tasks: document.getElementById('usePreviousTasks').checked,
        ewc_lambda: parseFloat(document.getElementById('ewcLambda').value),
        epochs: parseInt(document.getElementById('epochs').value),
        learning_rate: parseFloat(document.getElementById('learningRate').value),
        use_memory_efficient: true
    };
    
    formData.append('config', JSON.stringify(config));
    formData.append('dataset', datasetFile);
    
    // 送信ボタンを無効化
    const submitButton = event.target.querySelector('button[type="submit"]');
    submitButton.disabled = true;
    submitButton.textContent = '🔄 処理中...';
    
    try {
        const response = await fetch('/api/continual-learning/start', {
            method: 'POST',
            body: formData
        });
        
        const responseData = await response.json();
        
        if (!response.ok) {
            throw new Error(responseData.detail || 'エラーが発生しました');
        }
        
        currentTaskId = responseData.task_id;
        showAlert('✅ ' + responseData.message, 'success');
        
        // フォームをリセット
        document.getElementById('continualLearningForm').reset();
        
        // タスク一覧タブに切り替え
        document.querySelectorAll('.tab')[1].click();
        
        // タスク一覧を更新
        loadTasks();
        
    } catch (error) {
        console.error('エラー詳細:', error);
        showAlert('エラー: ' + error.message, 'error');
    } finally {
        // 送信ボタンを再有効化
        submitButton.disabled = false;
        submitButton.textContent = '🚀 継続学習を開始';
    }
}

// アラート表示
function showAlert(message, type) {
    const statusDiv = document.getElementById('currentTaskStatus');
    const alertClass = type === 'error' ? 'alert-error' : 'alert-success';
    statusDiv.innerHTML = '<div class="alert ' + alertClass + '">' + message + '</div>';
}
{% endblock %}