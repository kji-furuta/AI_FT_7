# 土木道路設計特化型RAGシステム アーキテクチャ設計書

## 1. システム概要

本システムは、土木道路設計に特化したハイブリッドRAG（Retrieval-Augmented Generation）システムです。既存のAI_FT_3ファインチューニングシステムと統合し、道路設計基準書・法令・技術文書から正確な情報を検索・引用して回答を生成します。

## 2. システム構成

### 2.1 全体アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                        Web UI (Streamlit)                     │
├─────────────────────────────────────────────────────────────┤
│                   RAG Query Engine                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ Hybrid Search│  │  Re-ranking  │  │  Citation    │      │
│  │   Engine     │  │   Module     │  │  Generator   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
├─────────────────────────────────────────────────────────────┤
│                 Document Processing Layer                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ PDF Parser   │  │Table Extract │  │  OCR Engine  │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
├─────────────────────────────────────────────────────────────┤
│                    Vector Database                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   Qdrant     │  │  Embeddings  │  │  Metadata    │      │
│  │   (Local)    │  │  (E5-large)  │  │   Store      │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
├─────────────────────────────────────────────────────────────┤
│              LLM Layer (Integrated with AI_FT_3)             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ Base Model   │  │ Fine-tuned   │  │  Prompt      │      │
│  │ (Llama 3.1) │  │   Models     │  │  Templates   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 技術スタック

#### 基盤技術
- **オーケストレーション**: LlamaIndex 0.10.x
- **ベクトルデータベース**: Qdrant 1.7.x (ローカル版)
- **埋め込みモデル**: intfloat/multilingual-e5-large
- **LLM**: 
  - 既存のファインチューニング済みモデル
  - Llama-3.1-70B-Instruct (新規)
- **図表処理**: LayoutLMv3 + OCR

#### 補助ツール
- **PDF処理**: PyMuPDF + pdfplumber
- **テーブル認識**: Camelot/Tabula
- **画像OCR**: EasyOCR（日本語対応）
- **Web UI**: Streamlit（既存のFastAPIと統合）

## 3. ディレクトリ構造

```
AI_FT_3/
├── src/
│   └── rag/                          # RAGシステム本体
│       ├── __init__.py
│       ├── config/                   # 設定ファイル
│       │   ├── __init__.py
│       │   ├── rag_config.yaml      # RAG設定
│       │   └── prompt_templates.yaml # プロンプトテンプレート
│       ├── core/                     # コア機能
│       │   ├── __init__.py
│       │   ├── query_engine.py      # クエリエンジン
│       │   ├── hybrid_search.py     # ハイブリッド検索
│       │   └── citation_engine.py   # 引用生成
│       ├── document_processing/      # 文書処理
│       │   ├── __init__.py
│       │   ├── pdf_processor.py     # PDF処理
│       │   ├── table_extractor.py   # 表抽出
│       │   ├── ocr_processor.py     # OCR処理
│       │   └── chunking_strategy.py # チャンキング戦略
│       ├── indexing/                 # インデックス管理
│       │   ├── __init__.py
│       │   ├── vector_store.py      # ベクトルストア
│       │   ├── embedding_model.py   # 埋め込みモデル
│       │   └── metadata_manager.py  # メタデータ管理
│       ├── retrieval/                # 検索機能
│       │   ├── __init__.py
│       │   ├── semantic_search.py   # 意味検索
│       │   ├── keyword_search.py    # キーワード検索
│       │   └── reranker.py          # リランキング
│       ├── specialized/              # 専門機能
│       │   ├── __init__.py
│       │   ├── numerical_handler.py # 数値データ処理
│       │   ├── unit_normalizer.py   # 単位正規化
│       │   └── version_manager.py   # バージョン管理
│       └── evaluation/               # 評価システム
│           ├── __init__.py
│           ├── metrics.py           # 評価メトリクス
│           └── test_dataset.py      # テストデータセット
├── data/
│   └── rag_documents/                # RAG用文書
│       ├── road_standards/           # 道路設計基準書
│       ├── regulations/              # 法令・規則
│       └── technical_guides/         # 技術ガイド
├── qdrant_data/                      # Qdrantデータ（ローカル）
├── app/
│   └── rag_interface.py             # RAG Web UI
└── scripts/
    └── rag/
        ├── setup_rag_env.sh          # RAG環境セットアップ
        ├── index_documents.py        # 文書インデックス作成
        └── evaluate_rag.py           # RAGシステム評価
```

## 4. 実装フェーズ

### フェーズ1: 技術スタック選定とプロトタイプ構築（2-3週間）
- 環境構築とライブラリインストール
- 基本的なRAGパイプラインの実装
- 既存システムとの統合点の確認

### フェーズ2: インジェスチョンパイプライン構築（3-4週間）
- PDF処理システムの実装
- 道路設計文書専用のチャンキング戦略
- メタデータ付与システム

### フェーズ3: 検索・生成システムの実装（2-3週間）
- ハイブリッド検索エンジン
- 引用機能付き生成エンジン
- プロンプトエンジニアリング

### フェーズ4: 専門機能の実装（2-3週間）
- 数値・表データの特殊処理
- 単位正規化システム
- 文書バージョン管理

### フェーズ5: 評価・最適化（2週間）
- 評価用データセット作成
- システムパフォーマンス測定
- 精度向上のための調整

### フェーズ6: 本番環境構築（1週間）
- GPU最適化設定
- Web UIの実装
- 既存システムとの完全統合

## 5. 主要機能

### 5.1 ハイブリッド検索
- ベクトル検索（意味的類似性）
- キーワード検索（専門用語の正確な一致）
- 両者の結果を統合したリランキング

### 5.2 引用機能
- 回答に使用した原文の正確な引用
- 出典（文書名、章節、ページ番号）の明記
- 複数の基準がある場合の網羅的な列挙

### 5.3 専門的な処理
- 数値と単位の正規化
- 表データの構造化
- 図表のOCRと説明文生成
- 技術用語の抽出と重み付け

### 5.4 バージョン管理
- 文書の改訂履歴管理
- 特定バージョンでの検索
- 変更点の追跡

## 6. 既存システムとの統合

### 6.1 ファインチューニングモデルの活用
- RAGで検索した情報を基に、ファインチューニング済みモデルで回答生成
- 道路設計の専門知識を活かした高品質な応答

### 6.2 統一されたWeb UI
- 既存のFastAPI（ポート8050）にRAG機能を追加
- ファインチューニングとRAGの両機能をシームレスに利用

### 6.3 共通のデータ管理
- 学習データとRAG文書の統合管理
- メタデータの共有

## 7. パフォーマンス目標

- **検索精度**: 90%以上の正答率
- **応答時間**: 5秒以内（通常のクエリ）
- **引用精度**: 95%以上の正確な出典提示
- **同時接続**: 10ユーザーまで対応

## 8. セキュリティとプライバシー

- ローカル環境での完結（外部APIへの依存なし）
- 文書のアクセス制御
- 監査ログの記録

## 9. 今後の拡張性

- マルチモーダル対応（CAD図面の理解）
- リアルタイム更新（新しい基準の自動取り込み）
- 多言語対応（英語・中国語）
- クラウド展開オプション